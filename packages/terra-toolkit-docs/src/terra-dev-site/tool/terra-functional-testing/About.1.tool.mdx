import { Badge } from '@cerner/terra-functional-testing/package.json?dev-site-package';

<Badge />

# Terra Functional Testing

The terra-functional-testing library is a utility for developing automation tests. The library extends the [WebdriverIO Framework](https://webdriver.io/) to facilitate automating accessibility and functional testing for Terra projects.

## Getting Started

To get started ensure [docker](https://www.docker.com/) has been installed. The terra-functional-testing library uses docker to setup and run tests in a containerized environment.

Install with npm:

```
npm install --save-dev @cerner/terra-functional-testing
```

## Test Runner

A test runner is provided for local development and should be invoked using the [terra-cli](https://engineering.cerner.com/terra-ui/dev_tools/cerner/terra-cli/about).

### Options

| Option                           | Type    | Default                 | Description                                                                                                                               |
|----------------------------------|---------|-------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| --assetServerPort                | number  | 8080                    | The port to run the webpack and express asset services on.                                                                                |
| --browsers                       | array   |                         | A list of browsers for the test run.                                                                                                      |
| --config, -c                     | string  |                         | A file path to the test runner configuration.                                                                                             |
| --disableSeleniumService         | boolean | false                   | A flag to disable the selenium docker service.                                                                                            |
| --externalHost                   | string  |                         | The host address the testing environment is connected to.                                                                                 |
| --externalPort                   | number  |                         | The port mapping from the host to the container.                                                                                          |
| --formFactors                    | array   |                         | A list of form factors for the test run. One of tiny, small, medium, large, huge, or enormous                                             |
| --gridUrl                        | string  |                         | The remote selenium grid address.                                                                                                         |
| --keepAliveSeleniumDockerService | boolean | false                   | Determines to keep the selenium docker service running upon test completion.                                                              |
| --locales                        | array   | en                      | A list of language locales for the test run.                                                                                              |
| --site                           | string  |                         | A file path to a static directory of assets. When defined, an express server will launch to serve the assets and disable running webpack. |
| --spec                           | array   |                         | A list of spec file paths.                                                                                                                |
| --suite                          | array   |                         | Overrides specs and runs only the defined suites.                                                                                         |
| --themes                         | array   | terra-default-theme     | A list of themes for the test run.                                                                                                        |
| --updateScreenshots, -u          | boolean | false                   | Updates all reference screenshots with the latest screenshots.                                                                            |

The following example will run the test suite a total of four times. Once for each permutation of the specified locales and form factors.

package.json
```json
{
  "scripts": {
    "wdio": "npm run terra wdio --locales en fr --formFactors tiny huge"
  }
}
```

## Form Factors

Tests can be executed in any of the following supported form factors:

| Size     | Width | Height |
|----------|-------|--------|
| tiny     | 470   | 768    |
| small    | 622   | 768    |
| medium   | 838   | 768    |
| large    | 1000  | 768    |
| huge     | 1300  | 768    |
| enormous | 1500  | 768    |

### Terra.describeViewports

`Terra.describeViewports` is a top level `describe` block for the spec file. All tests within this block will be executed for each given viewport(s). This block should not be nested within itself. If tests need to run against different viewports, then they should be created under a separate top level `Terra.describeViewports` block. Only the above Terra defined viewports are supported. 'huge' is the default viewport. If a form factor is defined in the wdio configuration or environment variable, that form factor will supersede the viewports defined in this block. This block accepts these arguments in the following order:
- {string} title - The `describe` block title.
- {string[]} viewports - The list of Terra viewports to test.
- {function} - the test function to execute for each viewport.

```js
Terra.describeViewports('Test viewports', ['tiny', 'huge'], () => {
  it('test tiny and huge screens', () => {
    browser.url('/testing/route/');
    Terra.validates.screenshot();
  });
});
```

## Accessibility Testing

The testing library integrates [axe-core](https://github.com/dequelabs/axe-core) into the testing framework to help automate accessibility testing along side functional testing.

Axe will analyze the entire document when run and report accessibility violations. The following [tags](https://github.com/dequelabs/axe-core/blob/develop/doc/API.md#axe-core-tags) are enabled `wcag2a`, `wcag2aa`, `wcag21aa`, and `section508`. Each tag has an associated list of [rules](https://github.com/dequelabs/axe-core/blob/develop/doc/rule-descriptions.md) that will be checked against the document when axe is run.

Please note that not all accessibility testing can be automated. Axe provides a lightweight static analysis of the entire document to catch common accessibility violations, but it is the responsibility of each team and application to do thorough accessibility and functional testing manually when necessary.

### Terra.validates.accessibility

The accessibility assertion should only be invoked inside an `it` block. Invoking the assertion will run accessibility checks on the entire document. If accessibility violations are found the test step will fail. It is recommended to run accessibility checks at various steps in a functional workflow to check for violations at different stages of the application.

```js
it('should report no accessibility violations', () => {
  browser.url('/testing/route/');

  Terra.validates.accessibility(); // Fails if accessibility violations are found anywhere on the document.
});
```

The accessibility assertion accepts [options](https://github.com/dequelabs/axe-core/blob/develop/doc/API.md#options-parameter) that will be passed to axe for the document analysis.

```js
it('should override a rule configuration', () => {
  browser.url('/testing/route/');

  // Rule override for this specific test.
  const options = { rules: { 'color-contrast': { enabled: false } } };

  Terra.validates.accessibility(options);
});
```

## Validating element

A screenshot can be captured at any given point inside an `it` block in a test. The captured screenshot will be used as a reference artifact. Element validation is done by comparing the reference screenshot against the screenshot captured in future test runs at the same point in the test.

### Terra.validates.screenshot

The screenshot assertion should only be invoked inside an `it` block. Invoking the assertion will capture a screenshot at the time it is invoked. If no reference screenshot exists, one will be created in the `reference` folder with the given screenshot name. If such reference screenshot already exists, the new screenshot will be compared with the reference screenshot to validate visually that they are within the mismatch tolerance. If the mismatch exceeds the tolerance, the test step will fail and a screenshot showing the difference will be generated.

A name must be provided to be used as the screenshot name.

```js
it('should validate the screenshot', () => {
  browser.url('/testing/route/');

  Terra.validates.screenshot('screenshot-name'); // Fails if the new screenshot doesn't visually match the reference screenshot.
});
```

The screenshot naming pattern is as follows:

```js
base_directory/test_spec_directory/test_spec_name/__snapshots__/(reference|latest|diff)/theme/locale/browserName_terraViewportName/screenshot-name.png
```

The screenshot assertion accepts an optional second argument with the following keys.
  * `selector` - the element selector to use to capture the element for screenshot comparison. The default selector is `data-terra-test-content`.
  * `mismatchTolerance` - the number between 0 and 100 that defines the degree of mismatch to consider two images as identical. Increasing this value will decrease level of test coverage.

```js
it('should validate the screenshot with options', () => {
  browser.url('/testing/route/');

  const options = {
    selector: '#element-id',
    mismatchTolerance: 10,
  };

  Terra.validates.screenshot('screenshot-name', options);
});
```

### Terra.validates.element

The element assertion basically performs both `Terra.validates.accessibility` and `Terra.validates.screenshot` assertions. Like these two assertions the element assertion should also only be invoked inside an `it` block.

```js
it('should validate the element', () => {
  browser.url('/testing/route/');

  Terra.validates.element('screenshot-name'); // Fails if the new screenshot doesn't visually match the reference screenshot.
});
```

The element assertion accepts an optional second argument with the following keys.
  * `rules` - the accessibility [rules](https://github.com/dequelabs/axe-core/blob/master/doc/rule-descriptions.md) to use as overrides if necessary.
  * `selector` - the element selector to use to capture the element for screenshot comparison. The default selector is `data-terra-test-content`.
  * `mismatchTolerance` - the number between 0 and 100 that defines the degree of mismatch to consider two images as identical. Increasing this value will decrease level of test coverage.

```js
it('should validate the element with options', () => {
  browser.url('/testing/route/');

  const options = {
    rules: { 'color-contrast': { enabled: false } },
    selector: '#element-id',
    mismatchTolerance: 10,
  };

  Terra.validates.element('screenshot-name', options);
});
```

## Input Caret

### Terra.hideInputCaret

An editable text field in focus will have a blinking caret. Often times this blinking caret causes inconsistent test failures due to the blinking of the caret during screenshot capture. This situation can be avoided by using `Terra.hideInputCaret` to set the CSS caret color to of the element to be transparent. This method must be placed in a `before`, `beforeEach`, or `it` block or it will not be ran. This method accepts a selector string as an argument and will only apply to the first selector if multiple are found. The caret will automatically be hidden for body every time the page loads or refreshes.

```js
it('should hide the caret', () => {
  Terra.hideInputCaret('#inputID');
  const element = browser.element('#inputID');

  expect(element.getCSSProperty('caretColor').value).toEqual('rgba(0,0,0,0)');
});
```

## Locale Update (Case by Case)

### Terra.setApplicationLocale
Use `Terra.setApplicationLocale` to update a terra application's locale on a case by case basis; particularly useful for testing locale changes on a deployed application. This method accepts a string containing the `locale` to update to.

```js
it('should update an application's locale, () => {
  Terra.setApplicationLocale('en');
});
```
