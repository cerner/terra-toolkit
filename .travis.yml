language: node_js
sudo: required
services:
  - docker
branches:
  only:
    - main
before_install:
  # Clean install on any new build
  - npm run clean
jobs:
  include:
    - stage: danger lint and jest
      script:
        # clear the cache of any old build artifacts
        - rm -rf ./travis-build
        - npm run danger
        - npm run lint
        - npm run jest
    # Split out all the sizes to not eat up all the travis executors at once.

    - stage: wdio
      name: wdio
      # Don't clean install
      before_install: skip
      script:
        # using the travis env section to set env variables seems to break cache
        - npm run wdio

    - stage: publish
      script:
        - rm -rf ./travis-build
        # add auth token to .npmrc for lerna publish
        - echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" >> $HOME/.npmrc 2> /dev/null
        # Publish to npm write output to file
        - npx lerna publish from-package --yes > publish-output.txt
        # push tags to github based on output written to file
        - node ./scripts/release/gitTagMonoRepo.js

stages:
  - danger lint and jest
  - wdio
  - name: publish
    if: type != pull_request

