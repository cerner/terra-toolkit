# Nightwatch Utility Developer's Guide

Nightwatch.js is an easy to use Node.js based End-to-End (E2E) testing solution for browser based apps and websites. It uses the powerful W3C WebDriver API to perform commands and assertions on DOM elements. Full documentation regarding nightwatch can be found at http://nightwatchjs.org/.

- [Getting Started](#getting-started)
- [Configuration Setup](#configuration-setup)
- [Writing Tests](#writing-tests)
- [Running Tests](#running-tests)

## Getting Started
Terra Toolkit uses docker to setup, run, and tear down selenium to ensure a consistent testing environment locally and in continuous integration build systems. To use Terra Toolkit you must install docker on your machine. Installation instructions can be found at https://www.docker.com/.  **Requires Docker v17.09.0 or higher.**

- Install with [npm](https://www.npmjs.com): `npm install terra-toolkit --save-dev`

The [nightwatch](https://www.npmjs.com/package/nightwatch) peerDependency must be installed to utilize the Nightwatch Utilities.

- Install with npm: `npm install nightwatch --save-dev`

## Configuration Setup

Terra-toolkit provides a nightwatch setup function, called `nightwatchConfig`, which provides a default [nightwatch configuration](https://github.com/cerner/terra-toolkit/blob/master/src/nightwatch/nightwatch.config.js) that will setup the test environment, launch the webpack-dev-server, and run the nightwatch tests in the chrome browser. It takes three parameters:

1. the webpack configuration used to start the serve-static server
2. the src folders where nightwatch searches for the tests
3. the [optional] port number to start the serve-static server - defaults to port 8080

More information regarding the nightwatch configuration options can be found [here](http://nightwatchjs.org/gettingstarted#basic-settings).

To assist with quick setup, the toolkit provides the setup helper, `getPackageTestDirectories`, to aggregate all mono-repo package test folders when its supplied with the repository's `lerna.json` file.

NOTE: `getPackageTestDirectories` does assumes the package structure of 'package_name/tests/nightwatch'.

```javascript
// An example of a mono-repo configuration file:
const nightwatchConfig = require('terra-toolkit/lib/nightwatch/nightwatch.config.js').default;
const webpackConfig = require('./webpack.config');
const getPackageTestDirectories = require('terra-toolkit/lib/nightwatch/setup-helper.js').getPackageTestDirectories;

let srcFolders;
const isRepoTest = !process.cwd().includes('/packages/');

if (isRepoTest) {
  srcFolders = getPackageTestDirectories('lerna.json');
} else {
  srcFolders = 'tests/nightwatch/';
}

const config = nightwatchConfig(webpackConfig, srcFolders, 9000);

module.exports = config;
```

## Writing Tests

There are a few things to note about the nightwatch configuration generated by Terra-Toolkit:

- Test files should use `*-spec.js` naming format. The generated configuration filters on `**/*-spec.js`.
- An after test hook is provided which calls the nightwatch `.end()` function.
- Use `${browser.launchUrl}/#/test_url_path` to direct test urls. The generated configuration sets the launchUrl to `http://${ip.address()}:${port}`.
- Chrome is the default testing environment and it's default browser size is 800x600.

Then, to assist with testing various browser sizes, Terra-toolkit provides the responsive test helpers, `resizeTo` and `screenWidth`.
- `resizeTo` wraps the nightwatch test suite and handles browser resizing on the breakpoints provided.
    - The breakpoint options, `tiny`, `small`, `medium`, `large`, `huge`, and `enormous`, which represents the screen widths tested. These correspond to the screen widths of 470px, 622px, 838px, 1000px, 1300px, and 1500px respectively.
- `screenWidth` returns the current screen width.
    - This helper must be used in conjunction with `resizeTo`.

```javascript
const { resizeTo, screenWidth } = require('terra-toolkit/lib/nightwatch/responsive-helpers');

module.exports = resizeTo(['tiny', 'small', 'medium', 'large', 'huge', 'enormous'], {
  'Static test path one renders correctly': (browser) => {
    browser.url(`${browser.launchUrl}/#/test-path-1`);
    browser.expect.element('.test').text.to.equal('Test');
  },

  'Responsive test path two renders correctly': (browser) => {
    browser.url(`${browser.launchUrl}/#/test-path-2`);
    const width = screenWidth(browser);

    if (width <= browser.globals.breakpoints.tiny[0]) {
      browser.expect.element('.test').text.to.equal('Tiny Response');
    } else {
      browser.expect.element('.test').text.to.equal('Default Response');
    }
  },
});
```

Finally, it is **highly recommended** to use the expect API over the assert API. Expect is a Behavior Driven Development interface which aligns more appropriately with react renderings and interactions.

#### Writing Tests with ChromeDriver:
 - ChromeDriver clicks the center of an element.
 - ChromeDriver cannot click moving objects. More information [here](https://sites.google.com/a/chromium.org/chromedriver/help/clicking-issues).
 - ChromeDriver's clearValue functions correctly, but does not trigger a change for an element.

## Running Tests
Installation of nightwatch, providing access to the nightwatch test runner. To start the runner, add the nightwatch npm script to the package.json and then provide the wdio configuration file. The nightwatch test runner requires a configuration file to be passed either from the current directory or via the `--config` or `-c` followed by the config path.

```javascript
// NPM Script at the root-level of a mono-repo with config in same directory
"nightwatch": "nightwatch";

// NPM Script at a package-level of a mono-repo
"nightwatch": "nightwatch -c ../../nightwatch.conf.js";
```
